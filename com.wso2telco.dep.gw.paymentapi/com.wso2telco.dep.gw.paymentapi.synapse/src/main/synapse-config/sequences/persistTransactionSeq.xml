<?xml version="1.0" encoding="UTF-8"?>
<sequence name="persistTransactionSeq" onError="commonFault"
  trace="disable" xmlns="http://ws.apache.org/ns/synapse">
  <filter description="" regex="sb" source="fn:normalize-space($func:direction)">
    <then>
      <filter regex="AmountChargeHandler" source="$ctx:HANDLER">
        <then>
          <filter regex="201" source="$axis2:HTTP_SC">
            <then>
              <dbreport>
                <connection>
                  <pool>
                    <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
                  </pool>
                </connection>
                <statement>
                  <sql><![CDATA[insert into persisttansaction(consumerKey,msisdn,amount,currency) values(?,?,?,?)]]></sql>
                  <parameter expression="$ctx:CONSUMER_KEY" type="VARCHAR"/>
                  <parameter
                    expression="fn:substring-after($ctx:MSISDN,'tel:+')" type="VARCHAR"/>
                  <parameter expression="$ctx:chargeAmount" type="DECIMAL"/>
                  <parameter expression="//currency" type="VARCHAR"/>
                </statement>
              </dbreport>
            </then>
            <else/>
          </filter>
        </then>
        <else/>
      </filter>
    </then>
    <else/>
  </filter>
</sequence>
