<?xml version="1.0" encoding="UTF-8"?>
<sequence name="authenticatePaymentCall" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <property expression="$trp:Authorization" name="auth-header" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <property expression="$trp:X-JWT-Assertion" name="jwt-header" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <class name="org.wso2telco.dep.nashornmediator.NashornMediator">
        <property name="script" value="var String = Java.type('java.lang.String');         var temp_auth = mc.getProperty('jwt-header').trim();         var val= temp_auth.split('.');         var auth=val[1];         var jsonObj = JSON.parse(new String(Packages.org.apache.commons.codec.binary.Base64.decodeBase64(auth),'UTF-8'));         mc.setProperty('mobile1',jsonObj['mobile']); mc.setProperty('mobile1',jsonObj['mobile']); mc.setProperty('trustedstatus1',jsonObj['trustedstatus']);"/>
    </class>
    <property expression="fn:substring-after($ctx:MSISDN,'tel:+')" name="msisdn" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <filter regex="normal" source="get-property('trustedstatus1')" xmlns:ns="http://org.apache.synapse/xsd">
        <then>
            <log level="custom">
                <property name="trustedstatus" value="Normal User"/>
            </log>
            <filter xpath="get-property('mobile1') != $ctx:msisdn">
                <then>
                    <log level="full">
                        <property name="ERROR_MSG" value="Failure in mobile number validation."/>
                    </log>
                    <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
                    <property name="httpStatusCode" scope="default" type="STRING" value="500"/>
                    <property name="exceptionType" scope="default" type="STRING" value="POLICY_EXCEPTION"/>
                    <property name="messageId" scope="default" type="STRING" value="POL0299"/>
                    <property name="errorText" scope="default" type="STRING" value="Failure in mobile number validation."/>
                    <property name="errorVariable" scope="default" type="STRING" value=""/>
                    <sequence key="com.wso2telco.dep.common.response.exceptions.Sequence"/>
                </then>
                <else/>
            </filter>
        </then>
        <else>
            <log level="custom">
                <property name="trustedstatus" value="Fullytrusted/trusted User"/>
            </log>
        </else>
    </filter>
</sequence>
